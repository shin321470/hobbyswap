<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${item.title} + ' - SPEC'">å•†å“è©³æƒ…</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico?v=2}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        .product-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }

        .product-image-area {
            background: #e0e0e0;
            border: 2px solid var(--text-main);
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #888;
            position: relative;
            overflow: hidden;
        }

        .product-info-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .product-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            line-height: 1.1;
            margin: 0;
            text-transform: uppercase;
        }

        /* åƒ¹æ ¼å€å¡Š */
        .product-price-box {
            background: #fafafa;
            padding: 20px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .price-large {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3rem;
            color: var(--text-main);
            /* åƒ¹æ ¼ highlight */
            background: linear-gradient(120deg, transparent 0%, transparent 10%, var(--highlight) 10%, var(--highlight) 90%, transparent 90%);
        }

        .info-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            font-size: 0.95rem;
            margin-bottom: 10px;
            align-items: baseline;
        }

        .info-label {
            color: #666;
            font-weight: bold;
        }

        .info-value {
            color: var(--text-main);
        }

        .divider {
            height: 1px;
            background: #ddd;
            margin: 10px 0;
            border: none;
        }

        .action-box {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid var(--text-main);
            background: white;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .product-layout { grid-template-columns: 1fr; }
            .product-image-area { height: 300px; }
        }

        .reviews-section {
            margin-top: 50px;
            padding: 30px;
            border: 2px solid black;
            background: #fff;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.05);
        }

        .review-item {
            border-bottom: 1px solid #000;
            padding: 20px 0;
        }

        .review-item:last-child { border-bottom: none; }

        .review-form-container {
            margin-top: 40px;
            padding: 25px;
            background: var(--highlight);
            border: 3px solid black;
        }

        .review-form-container textarea {
            border: 2px solid black;
            font-family: 'Space Mono', monospace;
            padding: 15px;
            resize: none;
            margin-bottom: 15px;
        }

        .review-form-container select {
            border: 2px solid black;
            padding: 5px 10px;
            font-family: 'Space Mono', monospace;
            background: white;
        }
    </style>
</head>
<body>

<div class="navbar">
    <a th:href="@{/}" class="logo">HobbySwap</a>

    <div class="nav-links">
        <div class="nav-right-group" style="display: flex; align-items: center; gap: 20px;">

            <a th:href="@{/forum}" class="btn"
               style="height:45px; padding:0 20px; font-size:0.9rem; display: inline-flex; align-items: center; justify-content: center; border: 2px solid #000; box-shadow: 3px 3px 0px #000;"
               th:text="#{nav.forum}">
                ğŸ’¬ FORUM
            </a>

            <a th:href="@{/cart}" class="btn"
               style="height:45px; padding:0 20px; font-size:0.9rem; display: inline-flex; align-items: center; justify-content: center; border: 2px solid #000; box-shadow: 3px 3px 0px #000;"
               th:text="#{nav.cart}">
                ğŸ›’ CART
            </a>

            <div class="lang-dropdown">
                <button class="lang-btn">
                    <span>ğŸŒ LANGUAGE â–¼</span>
                </button>
                <div class="lang-content">
                    <a th:href="@{?lang=zh_TW}">ç¹é«”ä¸­æ–‡ [TW]</a>
                    <a th:href="@{?lang=en}">ENGLISH [EN]</a>
                    <a th:href="@{?lang=ja}">æ—¥æœ¬èª [JP]</a>
                </div>
            </div>

            <span th:if="${#authentication.principal != 'anonymousUser'}" style="display:flex; align-items:center; gap: 20px;">
                <div class="lang-dropdown">
                    <button class="lang-btn" style="background: var(--highlight); color: black; border: 2px solid black; min-width: 120px; font-family: 'Space Mono', monospace;">
                      <span th:text="${#authentication.principal.name}" style="font-weight:bold;">User</span>
                      <span style="font-size: 0.8rem; margin-left: 5px;">â–¼</span>
                    </button>
                    <div class="lang-content">
                        <a th:href="@{/mypage}" th:text="#{nav.mypage}">MY PAGE</a>
                        <a th:href="@{/private-chat}" th:text="#{nav.private_chat}">ğŸ’¬ ç§è¨Š</a>
                        <a th:href="@{/chat}" th:text="#{nav.chat}">ğŸ’¬ CHAT</a>
                        <a th:href="@{/items/new}" th:text="#{nav.sell}">SELL</a>
                    </div>
                </div>
                <form th:action="@{/logout}" method="post" style="display:flex; align-items:center;">
                    <button type="submit" class="btn-logout" th:text="#{nav.logout}">LOGOUT</button>
                </form>
            </span>

            <span th:if="${#authentication.principal == 'anonymousUser'}" style="display:flex; align-items:center; gap: 20px;">
                <a th:href="@{/login}" class="btn" style="height:40px; padding:0 15px; font-size:0.9rem; display: inline-flex; align-items: center; justify-content: center;" th:text="#{nav.login}">LOGIN</a>
            </span>
        </div>
    </div>
</div>

<div class="container">
    <a th:href="@{/}" class="back-link" th:text="#{item.back}">&larr; å›é¦–é </a>

    <div class="product-layout">

        <div class="product-image-area">
            <img th:if="${item.imageName != null}"
                 th:src="@{'/uploads/' + ${item.imageName}}"
                 style="width: 100%; height: 100%; object-fit: cover;">

            <span th:if="${item.imageName == null}">
                NO IMAGE DATA
            </span>
        </div>

        <div class="product-info-area">

            <h1 class="product-title" th:text="${item.title}">å•†å“åç¨±</h1>

            <div class="product-price-box">
                <span class="price-large" th:text="'$ ' + ${item.price}">$ 1000</span>
                <span th:if="${item.status == 'SOLD'}" class="sold-stamp" style="position:static; transform:none; font-size:1.5rem; padding:5px 10px; border-width:2px;" th:text="#{item.sold}">SOLD</span>
            </div>

            <div style="margin-top: 10px; font-weight: bold; color: #666; font-family: 'Space Mono', monospace;">
                <span th:text="#{item.stock_quantity}">STOCK:</span>
                <span th:text="${item.stockQuantity}">0</span>

                <span style="margin-left: 20px;" th:text="#{item.category}">CATEGORY:</span>

                <span th:switch="${item.category}"
                      style="color: var(--highlight); background: black; padding: 2px 6px; border-radius: 2px;">

                    <span th:case="'CLOTHING'" th:text="#{item.category.clothing}">æœé£¾</span>
                    <span th:case="'BOOKS'" th:text="#{item.category.books}">æ›¸ç±</span>
                    <span th:case="'TOYS'" th:text="#{item.category.toys}">ç©å…·</span>
                    <span th:case="'ELECTRONICS'" th:text="#{item.category.electronics}">3C é›»å­</span>
                    <span th:case="'OTHERS'" th:text="#{item.category.others}">å…¶ä»–</span>

                    <span th:case="*">æœªåˆ†é¡</span>
                </span>
            </div>

            <hr class="divider">

            <div>
                <h4 style="margin: 10px 0; text-decoration: underline;" th:text="#{item.shipping}">é‹é€è³‡è¨Š</h4>

                <div class="info-row">
                    <span class="info-label" th:text="#{item.shipping_from}">å‡ºè²¨åœ°é»</span>
                    <span class="info-value" th:text="#{item.shipping_location}">Taipei, Taiwan</span>
                </div>
                <div class="info-row">
                    <span class="info-label" th:text="#{item.shipping_fee}">é‹è²»</span>
                    <span class="info-value" >$ 60 (7-11 / FamilyMart)</span>
                </div>

                <div class="info-row">
                    <span class="info-label" th:text="#{item.shipping_est}">é è¨ˆé€é”</span>
                    <span class="info-value">3 - 5 Days</span>
                </div>
            </div>

            <hr class="divider">

            <div>
                <h4 style="margin: 10px 0; text-decoration: underline;" th:text="#{item.spec}">å•†å“è¦æ ¼</h4>

                <div class="info-row">
                    <span class="info-label" th:text="#{item.condition}">å•†å“ç‹€æ³</span>
                    <span class="info-value" th:text="#{item.condition.good}">Used - Good</span>
                </div>

                <div class="info-row">
                    <span class="info-label" th:text="#{item.date}">ä¸Šæ¶æ™‚é–“</span>
                    <span class="info-value"
                          th:text="${#temporals.format(item.uploadDate, 'yyyy-MM-dd')}">
            2023-01-01
        </span>
                </div>

                <div class="info-row" style="align-items: flex-start;">
                    <span class="info-label" th:text="#{item.desc}">æè¿°</span>
                    <span class="info-value" th:text="${item.description}" style="white-space: pre-wrap;">å•†å“æè¿°å…§å®¹...</span>
                </div>
            </div>

            <div class="action-box" th:if="${item.status == 'ON_SALE'}">
                <div class="info-row">
                    <span class="info-label" th:text="#{item.payment}">ä»˜æ¬¾æ–¹å¼</span>
                    <span class="info-value" th:text="#{item.payment_desc}">Credit / ATM</span>
                </div>

                <div th:if="${#authentication.principal == 'anonymousUser'}" style="text-align: center; margin-top: 15px;">
                    <a th:href="@{/login}" class="btn" th:text="#{nav.login}">LOGIN</a>
                    <span style="margin-left: 10px;" th:text="#{item.login_first}">to buy</span>
                </div>

                <div th:if="${#authentication.principal != 'anonymousUser'}">

                    <div th:if="${#authentication.name != item.seller.email}"
                         style="display: flex; gap: 15px; align-items: center; margin-top: 20px; height: 65px;">

                        <button type="button" id="fav-btn" class="btn-fav"
                                th:classappend="${isFavorite} ? 'active' : ''"
                                th:onclick="'toggleFavorite(' + ${item.id} + ')'"
                                style="height: 100%; width: 65px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid black; background: white;">
                            <span id="fav-icon" th:text="${isFavorite} ? 'â™¥' : 'â™¡'" style="font-size: 2rem;">â™¡</span>
                        </button>

                        <div style="display: flex; flex: 1; gap: 15px; align-items: center; height: 100%;">

                            <div style="display: flex; align-items: center; height: 100%;">
                                <div class="qty-label" style="white-space: nowrap; margin-right: 10px;" th:text="#{item.quantity}">æ•¸é‡:</div>
                                <button type="button" class="qty-btn" onclick="updateQty(-1)" th:disabled="${item.stockQuantity == 0}" style="height: 100%; border-right: none;">-</button>
                                <input type="number" id="buy-qty" name="quantity" min="1" th:max="${item.stockQuantity}" value="1"
                                       class="input-brutal" th:disabled="${item.stockQuantity == 0}"
                                       style="width: 60px; height: 100%; text-align: center; border-left: none; border-right: none;">
                                <button type="button" class="qty-btn" onclick="updateQty(1)" th:disabled="${item.stockQuantity == 0}" style="height: 100%; border-left: none;">+</button>
                            </div>

                            <form th:action="@{/cart/add}" method="post" style="height: 100%;"
                                  onsubmit="document.getElementById('hidden-cart-qty').value = document.getElementById('buy-qty').value">
                                <input type="hidden" name="itemId" th:value="${item.id}">
                                <input type="hidden" name="quantity" id="hidden-cart-qty" value="1">
                                <button type="submit" class="btn-fav"
                                        style="background: white; color: black; border: 2px solid black; height: 100%; width: 65px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"
                                        th:disabled="${item.stockQuantity == 0}">
                                    ğŸ›’
                                </button>
                            </form>

                            <form th:action="@{'/items/' + ${item.id} + '/buy'}" method="post" style="flex: 1; height: 100%;">
                                <input type="hidden" name="quantity" onparentsubmit="this.value = document.getElementById('buy-qty').value" >

                                <button type="submit" class="btn"
                                        style="width: 100%; height: 100%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;"
                                        th:disabled="${(item.stockQuantity ?: 0) == 0}"
                                        th:styleappend="${(item.stockQuantity ?: 0) == 0 ? '; background: #ff4444 !important; color: white !important; cursor: not-allowed; border-color: black;' : ''}"
                                        th:text="${(item.stockQuantity ?: 0) > 0} ? #{item.buy} : 'SOLD OUT'">
                                    BUY NOW
                                </button>
                            </form>
                        </div>
                    </div>

                    <div th:if="${#authentication.name == item.seller.email}"
                         style="text-align: center; margin-top: 15px; padding: 10px; background: #eee; color: #666; border: 1px dashed #ccc;">

                        <span style="font-weight: bold;" th:text="#{item.self_buy_error}">
                            ğŸš« è³£å®¶ç„¡æ³•è³¼è²·è‡ªå·±çš„å•†å“
                        </span>

                    </div>

                </div>
            </div>

            <div class="action-box" th:if="${item.status == 'SOLD' or item.stockQuantity == 0}"
                 style="background: #f0f0f0; border-color: #ccc;">
                <h2 style="color: #999; text-align: center; margin: 0;" th:text="#{item.sold}">SOLD OUT</h2>
            </div>

        </div>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">

    <div class="reviews-section">
        <h3 style="font-family: 'Archivo Black', sans-serif; text-transform: uppercase;" th:text="#{item.reviews.title}">Reviews</h3>

        <div th:if="${reviews.empty}" style="padding: 20px; border: 1px dashed black; text-align: center; color: #888;"
             th:text="#{item.reviews.empty}">
            NO REVIEWS YET. BE THE FIRST!
        </div>

        <div th:each="review : ${reviews}" class="review-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="font-size: 1.1rem; text-decoration: underline;" th:text="${review.user.name}">User</strong>
                <span style="background: black; color: var(--highlight); padding: 2px 8px; font-weight: bold;">
                <span th:text="${review.rating}">5</span>/5 â˜…
            </span>
            </div>
            <p th:text="${review.content}" style="margin: 15px 0; line-height: 1.6; font-family: 'Space Mono', monospace;">è©•è«–å…§å®¹</p>
            <small th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}" style="color: #666;"></small>
        </div>

        <div sec:authorize="isAuthenticated()" class="review-form-container">
            <h4 style="margin-top: 0; text-transform: uppercase;" th:text="#{item.reviews.leave}">Leave a Review</h4>
            <form th:action="@{'/items/' + ${item.id} + '/review'}" method="post">
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold;">RATING:</label>
                    <select name="rating">
                        <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                        <option value="4">â˜…â˜…â˜…â˜… (4)</option>
                        <option value="3">â˜…â˜…â˜… (3)</option>
                        <option value="2">â˜…â˜… (2)</option>
                        <option value="1">â˜… (1)</option>
                    </select>
                </div>
                <textarea name="content" rows="4" th:placeholder="#{item.reviews.placeholder}" required style="width: 100%;"></textarea>
                <button type="submit" class="btn" style="width: 200px;" th:text="#{item.reviews.submit}">POST REVIEW</button>
            </form>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-grid">
        <div class="footer-col">
            <h4 th:text="#{footer.company}">COMPANY</h4>
            <ul class="footer-links">
                <li><a href="#" th:text="#{footer.brand}">é—œæ–¼æˆ‘å€‘ BRAND STORY</a></li>
                <li><a href="#" th:text="#{footer.store}">é–€å¸‚è³‡è¨Š STORE</a></li>
                <li><a href="#" th:text="#{footer.privacy}">éš±ç§æ¬Šæ”¿ç­– PRIVACY</a></li>
                <li><a href="#" th:text="#{footer.terms}">æœå‹™æ¢æ¬¾ TERMS</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4 th:text="#{footer.service}">SERVICE</h4>
            <ul class="footer-links">
                <li><a href="#" th:text="#{footer.faq}">å¸¸è¦‹å•é¡Œ FAQ</a></li>
                <li><a href="#" th:text="#{footer.delivery}">é‹é€æ”¿ç­– DELIVERY</a></li>
                <li><a href="#" th:text="#{footer.return}">é€€æ›è²¨æœå‹™ RETURN</a></li>
                <li><a href="#" th:text="#{footer.vip}">æœƒå“¡åˆ¶åº¦ VIP</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4 th:text="#{footer.contact}">CONTACT US</h4>
            <div class="contact-info">
                <p><strong>TEL:</strong> 02-9487-5566</p>
                <p><strong>EMAIL:</strong> help@hobbyswap.com</p>
                <p><strong>TIME:</strong> MON - SUN / 11:00 - 20:00</p>
            </div>
        </div>

        <div class="footer-col">
            <h4 th:text="#{footer.follow}">FOLLOW US</h4>
            <div class="social-links">
                <a href="#">[ IG ]</a>
                <a href="#">[ FB ]</a>
                <a href="#">[ YT ]</a>
            </div>
        </div>
    </div>

    <div class="copyright">
        <div>
            &copy; <span th:text="#{footer.copyright}">2025 HOBBYSWAP SUPPLY. ALL RIGHTS RESERVED.</span>
        </div>
        <div class="payment-icons">
            <span>VISA</span>
            <span>MASTER</span>
            <span>JCB</span>
            <span>APPLE PAY</span>
        </div>
    </div>
</footer>

<script>
    function updateQty(change) {
        var input = document.getElementById('buy-qty');
        var currentVal = parseInt(input.value) || 1;
        var maxVal = parseInt(input.getAttribute('max'));
        var newVal = currentVal + change;
        if (newVal >= 1 && newVal <= maxVal) {
            input.value = newVal;
        }
    }

    function toggleFavorite(itemId) {
        const btn = document.getElementById('fav-btn');
        const icon = document.getElementById('fav-icon');

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/items/${itemId}/favorite`, {
            method: 'POST',
            headers: {
                [header]: token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
        if (response.ok) {
            const isActive = btn.classList.toggle('active');
            icon.innerText = isActive ? 'â™¥' : 'â™¡';
        } else if (response.status === 403) {
            // å¦‚æœé‚„æ˜¯ 403ï¼Œè¡¨ç¤ºæ¬Šæ–éæœŸæˆ–çœŸçš„æ²’ç™»å…¥
            alert("é€£ç·šé€¾æ™‚æˆ–æœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥");
            window.location.href = "/login";
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
</body>
</html>