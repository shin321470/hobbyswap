<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title} + ' - HobbySwap Forum'">ÊñáÁ´†Ë©≥ÊÉÖ</title>
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .post-card {
        border: 3px solid black;
        box-shadow: 10px 10px 0px #000;
        background: white;
        padding: 40px;
        margin-bottom: 50px;
        position: relative;
    }

    .post-header {
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    .post-title {
        font-family: 'Archivo Black', sans-serif;
        font-size: 2.5rem;
        margin: 0 0 15px 0;
        line-height: 1.2;
        text-transform: uppercase;
    }

    .post-meta {
        display: flex;
        gap: 20px;
        font-family: 'Space Mono', monospace;
        font-size: 0.9rem;
        color: #666;
        align-items: center;
    }

    .meta-tag {
        background: black;
        color: var(--highlight);
        padding: 4px 10px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .post-content {
        font-size: 1.15rem;
        line-height: 1.8;
        white-space: pre-wrap;
        font-family: sans-serif;
        color: #333;
    }

    .item-embed {
        margin-top: 40px;
        border: 2px solid black;
        background: #f9f9f9;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.1s;
    }

    .item-embed:hover {
        background: var(--highlight);
        transform: translateY(-2px);
        box-shadow: 4px 4px 0px #000;
    }

    .item-embed img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid black;
        background: white;
    }

    .comments-header {
        font-family: 'Archivo Black', sans-serif;
        font-size: 1.8rem;
        margin-bottom: 30px;
        text-transform: uppercase;
        border-bottom: 4px solid var(--highlight);
        display: inline-block;
        padding-right: 20px;
    }

    .comment-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .avatar {
        width: 50px;
        height: 50px;
        background: black;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Archivo Black';
        font-size: 1.5rem;
        flex-shrink: 0;
        border: 2px solid black;
    }

    .comment-body {
        flex: 1;
        background: white;
        border: 2px solid #ddd;
        padding: 20px;
        position: relative;
    }

    .comment-row.is-author .comment-body {
        border: 2px solid black;
        box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
    }

    .comment-meta {
        font-family: 'Space Mono', monospace;
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }

    .author-badge {
        background: var(--highlight);
        color: black;
        padding: 2px 6px;
        font-size: 0.7rem;
        margin-left: 10px;
        border: 1px solid black;
        font-weight: bold;
    }

    .reply-list {
        margin-top: 15px;
        margin-left: 0;
        padding-left: 20px;
        border-left: 3px solid #ddd;
    }

    .reply-item {
        background: #f5f5f5;
        padding: 10px 15px;
        margin-bottom: 10px;
        font-size: 0.95rem;
        position: relative;
    }

    .input-brutal {
        width: 100%;
        padding: 15px;
        border: 2px solid black;
        font-family: 'Space Mono', monospace;
        background: #fff;
    }

    .input-brutal:focus {
        outline: none;
        border-color: var(--highlight);
        box-shadow: 4px 4px 0px #000;
    }

    .btn-delete {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        font-weight: bold;
        transition: color 0.2s;
    }
    .btn-delete:hover { color: red; }

  </style>
</head>
<body>

<div class="navbar">
  <a th:href="@{/}" class="logo">HobbySwap</a>

  <div class="nav-links">
    <div class="nav-right-group" style="display: flex; align-items: center; gap: 20px;">
      <a th:href="@{/forum}" class="btn"
         style="height:45px; padding:0 20px; font-size:0.9rem; display: inline-flex; align-items: center; justify-content: center; border: 2px solid #000; box-shadow: 3px 3px 0px #000;"
         th:text="#{nav.back_forum}">
        ‚Üê FORUM
      </a>

      <a th:href="@{/cart}" class="btn"
         style="height:45px; padding:0 20px; font-size:0.9rem; display: inline-flex; align-items: center; justify-content: center; border: 2px solid #000; box-shadow: 3px 3px 0px #000;"
         th:text="#{nav.cart}">
        üõí CART
      </a>

      <span th:if="${#authentication.principal != 'anonymousUser'}" style="display:flex; align-items:center; gap: 20px;">
                <div class="lang-dropdown">
            <button class="lang-btn" style="background: var(--highlight); color: black; border: 2px solid black; min-width: 120px; font-family: 'Space Mono', monospace;">
              <span th:text="${#authentication.principal.name}" style="font-weight:bold;">User</span>
              <span style="font-size: 0.8rem; margin-left: 5px;">‚ñº</span>
            </button>
            <div class="lang-content">
                <a th:href="@{/mypage}" th:text="#{nav.mypage}">MY PAGE</a>
                <a th:href="@{/private-chat}" th:text="#{nav.private_chat}">üí¨ ÁßÅË®ä</a>
                <a th:href="@{/chat}" th:text="#{nav.chat}">üí¨ CHAT</a>
                <a th:href="@{/items/new}" th:text="#{nav.sell}">SELL</a>

                <div style="height: 2px; background: black; margin: 0;"></div>

                <a href="javascript:void(0)"
                   onclick="document.getElementById('logout-form').submit();"
                   style="color: red; font-weight: bold;"
                   th:text="#{nav.logout}">LOGOUT</a>
            </div>
        </div>

                <form id="logout-form" th:action="@{/logout}" method="post" style="display: none;">
            </form>
            </span>

      <div th:if="${#authentication.name == 'anonymousUser'}" style="text-align: center; margin-top: 40px; padding: 40px; border: 2px dashed black;">
        <p style="font-family: 'Space Mono'; margin-bottom: 20px;" th:text="#{comment.login_hint}">LOGIN TO JOIN THE DISCUSSION</p>

        <a th:href="@{/login-check(target=${#httpServletRequest.requestURI})}"
           class="btn"
           th:text="#{nav.login}">LOGIN</a>

      </div>

      <div class="lang-dropdown">
        <button class="lang-btn">
          <span>üåê LANGUAGE ‚ñº</span>
        </button>
        <div class="lang-content">
          <a th:href="@{?lang=zh_TW}">ÁπÅÈ´î‰∏≠Êñá [TW]</a>
          <a th:href="@{?lang=en}">ENGLISH [EN]</a>
          <a th:href="@{?lang=ja}">Êó•Êú¨Ë™û [JP]</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="post-card">
    <div class="post-header">
      <h1 class="post-title" th:text="${post.title}">Ê®ôÈ°å TITLE</h1>

      <div class="post-meta">
        <span class="meta-tag" th:text="${post.category.display}">CATEGORY</span>
        <span>
                    <span th:text="#{post.author}">BY</span>
                    <strong style="color: black;" th:text="${post.author.name}">User</strong>
                </span>
        <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">DATE</span>

        <div th:if="${#authentication.name == post.author.email}" style="margin-left: auto;">
          <form th:action="@{'/forum/' + ${post.id} + '/delete'}" method="post" style="display: inline;">
            <button type="submit" class="btn"
                    style="background: #c0392b; border: 2px solid #c0392b; color: #c0392b; font-size: 0.8rem; padding: 5px 15px; height:auto;"
                    onclick="return confirm('DELETE THIS POST?');">
              <span th:text="#{post.delete}">DELETE POST</span> üóëÔ∏è
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="post-content" th:text="${post.content}">
      ÊñáÁ´†ÂÖßÂÆπ...
    </div>

    <a th:if="${post.sharedItem != null}" th:href="@{'/items/' + ${post.sharedItem.id}}" style="text-decoration: none; color: inherit;">
      <div class="item-embed">
        <img th:if="${post.sharedItem.imageName != null}" th:src="@{'/uploads/' + ${post.sharedItem.imageName}}">
        <div style="flex: 1;">
          <div style="font-family: 'Space Mono'; font-size: 0.8rem; color: #666; margin-bottom: 5px;">
            üîó <span th:text="#{post.mentioned_item}">MENTIONED ITEM</span>
          </div>
          <div style="font-family: 'Archivo Black'; font-size: 1.2rem; text-transform: uppercase;" th:text="${post.sharedItem.title}">
            ITEM NAME
          </div>
          <div style="font-weight: bold; color: var(--highlight); background: black; display: inline-block; padding: 2px 8px; margin-top: 5px;"
               th:text="'$' + ${post.sharedItem.price}">$999</div>
        </div>
        <div style="font-size: 1.5rem;">‚ûî</div>
      </div>
    </a>
  </div>

  <div style="margin-top: 60px;">
    <h3 class="comments-header">
      <span th:text="#{comment.title}">COMMENTS</span>
      (<span th:text="${comments.size()}">0</span>)
    </h3>

    <div th:if="${comments.isEmpty()}"
         style="padding: 40px; border: 2px dashed #ccc; text-align: center; color: #999; font-family: 'Space Mono';">
      <span th:text="#{comment.empty}">NO COMMENTS YET. BE THE FIRST!</span>
    </div>

    <div th:each="comment : ${comments}"
         class="comment-row"
         th:classappend="${comment.author.email == post.author.email} ? 'is-author' : ''">

      <div class="avatar" th:text="${#strings.substring(comment.author.name, 0, 1).toUpperCase()}">U</div>

      <div class="comment-body">
        <div class="comment-meta">
          <div>
            <strong style="color: black; font-size: 1rem;" th:text="${comment.author.name}">User</strong>
            <span th:if="${comment.author.email == post.author.email}" class="author-badge" th:text="#{comment.badge.author}">OP</span>
          </div>

          <div style="display: flex; gap: 10px; align-items: center;">
            <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">Time</span>

            <form th:if="${#authentication.name == comment.author.email}"
                  th:action="@{'/forum/comments/' + ${comment.id} + '/delete'}" method="post" style="display:inline;">
              <button type="submit" class="btn-delete" title="Delete" onclick="return confirm('DELETE COMMENT?');">‚úï</button>
            </form>
          </div>
        </div>

        <div th:text="${comment.content}" style="line-height: 1.6;">Ë©ïË´ñÂÖßÂÆπ...</div>

        <div th:if="${!comment.replies.empty}" class="reply-list">
          <div th:each="reply : ${comment.replies}" class="reply-item">
            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                            <span>
                                <strong style="color: #333;" th:text="${reply.author.name}">ReplyUser</strong>
                                <span th:if="${reply.author.email == post.author.email}" class="author-badge" style="font-size: 0.6rem;">OP</span>
                            </span>

              <form th:if="${#authentication.name == reply.author.email}"
                    th:action="@{'/forum/comments/' + ${reply.id} + '/delete'}" method="post" style="display:inline;">
                <button type="submit" class="btn-delete" style="font-size: 0.8rem;" onclick="return confirm('DELETE REPLY?');">‚úï</button>
              </form>
            </div>
            <div th:text="${reply.content}">ÂõûË¶ÜÂÖßÂÆπ</div>
          </div>
        </div>

        <div th:if="${#authentication.name != 'anonymousUser'}" style="margin-top: 15px;">
          <button type="button"
                  style="background: none; border: none; color: #666; font-family: 'Space Mono'; font-size: 0.8rem; cursor: pointer; text-decoration: underline;"
                  th:onclick="'document.getElementById(\'reply-form-' + ${comment.id} + '\').style.display = \'block\''">
            ‚Ü™ <span th:text="#{comment.reply_btn}">REPLY</span>
          </button>

          <div th:id="'reply-form-' + ${comment.id}" style="display: none; margin-top: 10px;">
            <form th:action="@{'/forum/comments/' + ${comment.id} + '/reply'}" method="post" style="display: flex; gap: 10px;">
              <input type="text" name="content" class="input-brutal"
                     th:placeholder="#{comment.reply_placeholder}" required style="flex: 1; height: 40px; padding: 0 10px;">
              <button type="submit" class="btn" style="height: 40px; padding: 0 20px; font-size: 0.9rem;" th:text="#{comment.submit}">SEND</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div th:if="${#authentication.name != 'anonymousUser'}"
         style="margin-top: 40px; background: #eee; padding: 30px; border: 2px solid black;">
      <h4 style="margin-top: 0; font-family: 'Space Mono'; text-transform: uppercase;" th:text="#{comment.new_title}">LEAVE A COMMENT</h4>
      <form th:action="@{'/forum/' + ${post.id} + '/comment'}" method="post">
                <textarea name="content" rows="4" class="input-brutal"
                          th:placeholder="#{comment.placeholder}" required style="width: 100%; margin-bottom: 15px; resize: vertical; text-align: left;"></textarea>
        <button type="submit" class="btn" style="width: 200px;" th:text="#{comment.submit_main}">POST COMMENT</button>
      </form>
    </div>

    <div th:if="${#authentication.name == 'anonymousUser'}" style="text-align: center; margin-top: 40px; padding: 40px; border: 2px dashed black;">
      <p style="font-family: 'Space Mono'; margin-bottom: 20px;" th:text="#{comment.login_hint}">LOGIN TO JOIN THE DISCUSSION</p>
      <a th:href="@{/login}" class="btn" th:text="#{nav.login}">LOGIN</a>
    </div>
  </div>
</div>

</body>
</html>