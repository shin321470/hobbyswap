<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>å…¬å…±èŠå¤©å®¤</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        .chat-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #chat-box { height: 400px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-bottom: 20px; background: #f9f9f9; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .message.self { background-color: #e3f2fd; text-align: right; }
        .message.other { background-color: #fff; border: 1px solid #eee; }
        .sender-name { font-weight: bold; font-size: 0.8em; color: #666; display: block; }
        .controls { display: flex; gap: 10px; }
        #message-input { flex-grow: 1; padding: 10px; }
    </style>
</head>
<body>

<div class="navbar">
    <a href="/" class="logo">HobbySwap</a>
</div>

<div class="chat-container">
    <h2>ğŸ’¬ å¤§å®¶ä¾†èŠå¤©</h2>

    <div id="chat-box">
        <div th:each="msg : ${history}"
             class="message"
             th:classappend="${msg.sender == #authentication.name} ? 'self' : 'other'">

            <span class="sender-name" th:text="${msg.sender}">User</span>

            <span th:text="${msg.content}">Hello</span>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="message-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()" class="btn">ç™¼é€</button>
    </div>
</div>

<script>
    var stompClient = null;

    // 1. é€£ç·šåˆ° WebSocket
    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // è¨‚é–±å…¬å…±é »é“çš„è¨Šæ¯
            stompClient.subscribe('/topic/public', function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    // 2. ç™¼é€è¨Šæ¯
    function sendMessage() {
        var messageContent = document.getElementById('message-input').value;
        if(messageContent && stompClient) {
            var chatMessage = {
                content: messageContent,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            document.getElementById('message-input').value = '';
        }
    }

    // 3. é¡¯ç¤ºè¨Šæ¯åœ¨ç•«é¢ä¸Š
    function showMessage(message) {
        var chatBox = document.getElementById('chat-box');
        var messageElement = document.createElement('div');

        // åˆ¤æ–·æ˜¯è‡ªå·±ç™¼çš„é‚„æ˜¯åˆ¥äººç™¼çš„ (é€™è£¡ç°¡å–®åˆ¤æ–·ï¼Œå¯¦éš›å¯æ ¹æ“š User ID)
        messageElement.classList.add('message');
        messageElement.classList.add('other'); // é è¨­æ¨£å¼

        var contentHtml = '<span class="sender-name">' + message.sender + '</span>' +
            '<span>' + message.content + '</span>';

        messageElement.innerHTML = contentHtml;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
    }

    // æŒ‰ Enter ç™¼é€
    function handleKeyPress(e) {
        if(e.key === 'Enter'){
            sendMessage();
        }
    }

    // é é¢è¼‰å…¥å¾Œè‡ªå‹•é€£ç·š
    connect();
</script>

</body>
</html>